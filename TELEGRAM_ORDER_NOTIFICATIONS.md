# Telegram –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞—è–≤–∫–∞—Ö

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram Bot –æ —Å—Ç–∞—Ç—É—Å–µ –∑–∞—è–≤–æ–∫ –æ–±–º–µ–Ω–Ω–∏–∫–∞. –°–æ–æ–±—â–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π –∑–∞—è–≤–∫–∏, –∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

1. **–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏** (`status: created`)
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞—è–≤–∫–∏
   - –ö–Ω–æ–ø–∫–∞ "‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–ª" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã
   - –ö–Ω–æ–ø–∫–∞ "üì± –û—Ç–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É" –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ Mini App

2. **–ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞—è–≤–∫–∏** (`status: done`)
   - –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (–Ω–µ –Ω–æ–≤–æ–µ!)
   - –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "–û–ø–ª–∞—á–µ–Ω–∞, –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ"
   - –ö–Ω–æ–ø–∫–∞ "–Ø –æ–ø–ª–∞—Ç–∏–ª" –∏—Å—á–µ–∑–∞–µ—Ç
   - –û—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É"

3. **–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏** (`status: payed`)
   - –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
   - –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "–í—ã–ø–æ–ª–Ω–µ–Ω–∞"
   - –≠–º–æ–¥–∑–∏ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ ‚úÖ

4. **–ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏/—Ç–∞–π–º–∞—É—Ç–µ** (`status: rejected/timeout`)
   - –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º —Å—Ç–∞—Ç—É—Å–æ–º

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ Mini App –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** –≤ Firebase:
- –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ø–ª–∞–≥–∏–Ω–µ `telegram.client.ts`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `telegramUsers/{userId}`
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ username

```typescript
// plugins/telegram.client.ts
const user = telegramWebApp.value?.initDataUnsafe?.user
if (user?.id) {
  await $fetch('/api/telegram/saveUser', {
    method: 'POST',
    body: { telegramUser: user }
  })
}
```

### Server API

#### `/api/telegram/sendOrderNotification`
**POST** - –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞—è–≤–∫–µ

**Body:**
```json
{
  "transaction": {
    "sell": "usdt",
    "buy": "ton",
    "countSell": 100,
    "countBuy": 50,
    "address": "UQxxx...",
    "net": "TON",
    "telegram": "username",
    "status": "created",
    "id": 1234567890
  },
  "transactionKey": "-NxXxXxXxXxXx"
}
```

**Response:**
```json
{
  "success": true,
  "messageId": 123,
  "chatId": 456789
}
```

**–õ–æ–≥–∏–∫–∞:**
- –ò—â–µ—Ç `chatId` –ø–æ username –≤ Firebase (`telegramUsers/`)
- –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–ª –±–æ—Ç–∞)
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å inline –∫–Ω–æ–ø–∫–∞–º–∏
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `messageId` –∏ `chatId` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

#### `/api/telegram/updateOrderNotification`
**POST** - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**Body:**
```json
{
  "transaction": {
    "telegramMessageId": 123,
    "telegramChatId": 456789,
    "status": "done",
    ...
  },
  "transactionKey": "-NxXxXxXxXxXx"
}
```

**–õ–æ–≥–∏–∫–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `editMessageText` API Telegram
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∏ –∫–Ω–æ–ø–∫–∏ –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ

#### `/api/telegram/webhook`
**POST** - Webhook –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏–π –∫–Ω–æ–ø–æ–∫

**–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**
- `callback_query` - –Ω–∞–∂–∞—Ç–∏–µ inline –∫–Ω–æ–ø–æ–∫
  - `order_paid_{key}` - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `done`
- `message` - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î

### Composables

#### `useTelegramOrderNotifications()`

```typescript
const { sendOrderCreated, updateOrderStatus } = useTelegramOrderNotifications()

// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏
const response = await sendOrderCreated(transaction, transactionKey)
if (response?.messageId) {
  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å messageId –∏ chatId –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
}

// –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
await updateOrderStatus(updatedTransaction, transactionKey)
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### 1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏
`components/Exchanger/RightExchangerBlock.vue`

```typescript
const sendForm = async () => {
  const transactionRef = await Setter.pushToDb("transactions", payload)
  const transactionKey = transactionRef.key
  
  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  const telegramResponse = await sendOrderCreated(payload, transactionKey)
  
  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å messageId –¥–ª—è –±—É–¥—É—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  if (telegramResponse?.messageId) {
    await Setter.updateToDb({
      [`transactions/${transactionKey}/telegramMessageId`]: telegramResponse.messageId,
      [`transactions/${transactionKey}/telegramChatId`]: telegramResponse.chatId,
    })
  }
}
```

### 2. –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª—è telegram
`components/Exchanger/RightExchangerBlock.vue`

–ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤ Telegram Mini App –ø–æ–ª–µ telegram **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è**:

```typescript
onMounted(() => {
  if (isTelegramBrowser.value) {
    const telegramUser = getTelegramUserData()
    if (telegramUser?.username) {
      model.telegram = telegramUser.username
    } else if (telegramUser?.first_name) {
      model.telegram = telegramUser.first_name.replace(/\s+/g, '')
    }
  }
})

// –ü–æ–ª–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è readonly
const isTelegramAutoFilled = computed(() => {
  return isTelegramBrowser.value && model.telegram.length > 0
})
```

### 3. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
`components/Exchanger/TransactionBlock.vue`

```typescript
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ UI
const cancel = async (status: "done" | "rejected") => {
  await Setter.updateToDb(updates)
  
  // –û–±–Ω–æ–≤–∏—Ç—å Telegram —Å–æ–æ–±—â–µ–Ω–∏–µ
  await updateOrderStatus(
    { ...activeTransaction.value, status },
    activeTransaction.value.key
  )
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Firebase (–∫–æ–≥–¥–∞ –∞–¥–º–∏–Ω –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å)
watch(valueTransaction, async (val) => {
  if (val.status === "payed") {
    await updateOrderStatus(
      { ...activeTransaction.value, status: "payed" },
      activeTransaction.value.key
    )
  }
})
```

## –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

### –°—Ç–∞—Ç—É—Å: created
```
üÜï –ó–∞—è–≤–∫–∞ #abc123

üìä –°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã

üí∏ –û—Ç–¥–∞—ë—Ç–µ: 100 USDT
üí∞ –ü–æ–ª—É—á–∞–µ—Ç–µ: 50 TON

üì¨ –ê–¥—Ä–µ—Å: UQxxx...xxx
üåê –°–µ—Ç—å: TON

–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: 02.12.2025, 19:56:00

[‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–ª]
[üì± –û—Ç–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É]
```

### –°—Ç–∞—Ç—É—Å: done
```
‚è≥ –ó–∞—è–≤–∫–∞ #abc123

üìä –°—Ç–∞—Ç—É—Å: –û–ø–ª–∞—á–µ–Ω–∞, –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ

üí∏ –û—Ç–¥–∞—ë—Ç–µ: 100 USDT
üí∞ –ü–æ–ª—É—á–∞–µ—Ç–µ: 50 TON

üì¨ –ê–¥—Ä–µ—Å: UQxxx...xxx
üåê –°–µ—Ç—å: TON

–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: 02.12.2025, 19:56:00

[üì± –û—Ç–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É]
```

### –°—Ç–∞—Ç—É—Å: payed
```
‚úÖ –ó–∞—è–≤–∫–∞ #abc123

üìä –°—Ç–∞—Ç—É—Å: –í—ã–ø–æ–ª–Ω–µ–Ω–∞

üí∏ –û—Ç–¥–∞—ë—Ç–µ: 100 USDT
üí∞ –ü–æ–ª—É—á–∞–µ—Ç–µ: 50 TON

üì¨ –ê–¥—Ä–µ—Å: UQxxx...xxx
üåê –°–µ—Ç—å: TON

–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: 02.12.2025, 19:56:00

[üì± –û—Ç–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É]
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook
```bash
curl -X POST "https://api.telegram.org/bot<BOT_TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://your-domain.com/api/telegram/webhook"}'
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook
```bash
curl "https://api.telegram.org/bot<BOT_TOKEN>/getWebhookInfo"
```

### 3. –£–¥–∞–ª–∏—Ç—å webhook (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
```bash
curl -X POST "https://api.telegram.org/bot<BOT_TOKEN>/deleteWebhook"
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö Firebase

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```json
{
  "transactions": {
    "-NxXxXxXxXxXx": {
      "sell": "usdt",
      "buy": "ton",
      "countSell": 100,
      "countBuy": 50,
      "address": "UQxxx...",
      "telegram": "username",
      "status": "created",
      "telegramMessageId": 123,
      "telegramChatId": 456789,
      "id": 1234567890
    }
  }
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram
```json
{
  "telegramUsers": {
    "123456789": {
      "id": 123456789,
      "username": "username",
      "first_name": "John",
      "last_name": "Doe",
      "language_code": "ru",
      "last_interaction": 1701534960000
    }
  }
}
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_BOT_USERNAME=your_bot_username
SITE_URL=https://your-domain.com
```

## –õ–æ–≥–∏

- `[Telegram Webhook]` - —Å–æ–±—ã—Ç–∏—è webhook
- `[Telegram] Chat ID not found` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
- `[Telegram] Message not found` - —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

1. **–û–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –∑–∞—è–≤–∫—É** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `editMessageText` –≤–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

2. **–û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞** - –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª —Å –±–æ—Ç–æ–º, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è** - —Å—Ç–∞—Ç—É—Å –≤ Mini App –∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤—Å–µ–≥–¥–∞ —Å–æ–≤–ø–∞–¥–∞—é—Ç

4. **–ö–Ω–æ–ø–∫–∞ "–Ø –æ–ø–ª–∞—Ç–∏–ª"** - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ Firebase —á–µ—Ä–µ–∑ webhook, —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ Mini App

5. **Graceful degradation** - –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
